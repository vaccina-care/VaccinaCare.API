name: CI/CD Deploy to VPS

on:
  push:
    branches:
      - main  # M·ªói l·∫ßn push l√™n main s·∫Ω ch·∫°y CI/CD

jobs:
  deploy:
    name: Build & Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      # B∆∞·ªõc 1: Checkout code (clone to√†n b·ªô repo)
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0  # Clone to√†n b·ªô repo ƒë·ªÉ tr√°nh thi·∫øu file

      # B∆∞·ªõc 2: Debug ki·ªÉm tra file trong GitHub Actions (n·∫øu c·∫ßn)
      - name: Debug GitHub Actions Files
        run: ls -R

      # B∆∞·ªõc 3: Thi·∫øt l·∫≠p Docker
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # B∆∞·ªõc 4: ƒêƒÉng nh·∫≠p v√†o DockerHub
      - name: Log in to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # B∆∞·ªõc 5: Build & Push Docker Image
      - name: Build & Push Docker Image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/vaccinacareapi:latest -f VaccinaCare.API/Dockerfile .
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/vaccinacareapi:latest

      # B∆∞·ªõc 6: K·∫øt n·ªëi v√†o VPS v√† deploy
      - name: SSH v√†o VPS & Deploy
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.VPS_HOST }}        # IP c·ªßa VPS
          username: ${{ secrets.VPS_USER }}    # user VPS (th∆∞·ªùng l√† root)
          password: ${{ secrets.VPS_PASSWORD }} # m·∫≠t kh·∫©u VPS
          script: |
            echo "üöÄ ƒêang deploy tr√™n VPS..."

            # ƒêƒÉng nh·∫≠p v√†o DockerHub tr√™n VPS
            docker login -u ${{ secrets.DOCKERHUB_USERNAME }} -p ${{ secrets.DOCKERHUB_TOKEN }}

            # K√©o image m·ªõi nh·∫•t
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/vaccinacareapi:latest

            # Ch·∫°y container m·ªõi m√† kh√¥ng gi√°n ƒëo·∫°n d·ªãch v·ª•
            docker stop vaccinacare-api || true
            docker rm vaccinacare-api || true
            docker run -d --name vaccinacare-api -p 5000:5000 \
              --restart always \
              ${{ secrets.DOCKERHUB_USERNAME }}/vaccinacareapi:latest

            # X√≥a c√°c container/image c≈© ƒë·ªÉ gi·∫£i ph√≥ng dung l∆∞·ª£ng
            docker system prune -af 

            echo "‚úÖ Deploy th√†nh c√¥ng! API ƒëang ch·∫°y tr√™n http://103.211.201.162:5000"
